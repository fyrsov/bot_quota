# Telegram-бот «Квоты на дровницы»

Бот для учёта выдачи дровниц сотрудникам. Каждый сотрудник имеет месячную квоту; администратор управляет лимитами, просматривает статистику и выгружает отчёты в Excel.

---

## Стек

- Python 3.12+
- [aiogram 3.x](https://docs.aiogram.dev/) — Telegram Bot API
- SQLAlchemy (async) + aiosqlite — база данных SQLite
- pydantic-settings — конфигурация через `.env`
- openpyxl — генерация Excel-отчётов
- Docker + docker-compose — деплой через Portainer

---

## Возможности

### Сотрудник
| Действие | Описание |
|----------|----------|
| Регистрация | Онбординг при первом `/start`: ФИО, телефон, должность |
| Мой кабинет | Остаток квоты на месяц + история по месяцам с пагинацией |
| Взять дровницу | Ввод номера договора → подтверждение → списание квоты |
| Вернуть дровницу | Отмена записи за текущий месяц по номеру договора |

### Администратор
| Действие | Описание |
|----------|----------|
| Сотрудники | Список всех, карточка с квотой, удаление |
| Статистика | Выдачи по месяцам с разбивкой по сотрудникам |
| Квоты | Изменить лимит по роли или персонально для конкретного сотрудника |
| Вернуть (админ) | Отмена любой записи за текущий месяц по номеру договора |
| Выгрузить отчёт | Excel-файл за выбранный месяц |

---

## Роли и квоты

- **Должности:** Замерщик / Менеджер / Бригада
- **Квота по умолчанию:** 5 единиц в месяц для каждой роли
- **Приоритет квоты:** персональная (назначается администратором) → по роли → 5 по умолчанию
- **Сброс:** квота считается автоматически по записям текущего месяца (поле `month`)

---

## Быстрый старт

### 1. Создать `.env`

```env
BOT_TOKEN=токен_от_BotFather
ADMIN_IDS=123456789,987654321
DB_PATH=data/quota_bot.db
```

- `BOT_TOKEN` — получить у [@BotFather](https://t.me/BotFather)
- `ADMIN_IDS` — Telegram ID администраторов через запятую (узнать у [@userinfobot](https://t.me/userinfobot))

### 2. Локальный запуск

```bash
python -m venv .venv
.venv\Scripts\activate        # Windows
# source .venv/bin/activate   # Linux/macOS

pip install -r requirements.txt
python -m bot.main
```

### 3. Запуск через Docker

```bash
docker-compose up -d
```

### 4. Деплой через Portainer

1. Portainer → **Stacks** → **Add stack**
2. Вставить содержимое `docker-compose.yml`
3. В разделе **Env** добавить переменные из `.env`
4. **Deploy the stack**

---

## Структура проекта

```
quota_bot/
├── bot/
│   ├── config.py                  # Настройки (.env)
│   ├── main.py                    # Точка входа
│   ├── database/
│   │   ├── base.py                # Engine, сессия, init_db
│   │   ├── models.py              # User, Quota, Record
│   │   └── repositories/          # UserRepo, QuotaRepo, RecordRepo
│   ├── services/
│   │   ├── quota_service.py       # Логика взятия/возврата
│   │   └── export_service.py      # Генерация Excel
│   ├── handlers/
│   │   ├── onboarding.py          # /start, регистрация
│   │   ├── employee.py            # Функции сотрудника
│   │   └── admin.py               # Функции администратора
│   ├── keyboards/                 # Reply и Inline клавиатуры
│   ├── middlewares/
│   │   └── auth.py                # Сессия БД, user, is_admin
│   └── states/                    # FSM состояния
├── data/                          # SQLite база (создаётся автоматически)
├── .env                           # Секреты (не коммитить!)
├── .env.example                   # Шаблон переменных
├── Dockerfile
├── docker-compose.yml
└── requirements.txt
```

---

## База данных

| Таблица | Описание |
|---------|----------|
| `users` | telegram_id, ФИО, телефон, роль, is_admin |
| `quotas` | Лимиты по роли или персональные (user_id) |
| `records` | Записи выдачи: user_id, номер договора, месяц, is_cancelled |

---

## Безопасность

- Все пользовательские данные проходят валидацию (regex + ограничение длины)
- Только ORM-запросы — SQL-инъекции исключены
- Роутер администратора защищён фильтром `IsAdmin`
- `.env` и `data/` исключены из git через `.gitignore`
- Несколько администраторов поддерживаются через `ADMIN_IDS`
